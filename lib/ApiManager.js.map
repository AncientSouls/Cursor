{"version":3,"sources":["../src/lib/ApiManager.js"],"names":["ApiManager","adapterFindApi","adapterSend","relations","apiQuery","channelId","query","cursorId","findApi","then","api","set","receiveQuery","bundles","cursors","get","promises","push","Promise","cursorDestroyed"],"mappings":"ikBAAA,8B,+QAEA;;;;GAMA;;;;;;;;GAUA;;;;;;GAQA;;;;;;;GASA;;;;;GAOA;;;;MAKMA,W,YAEJ;;;;KAKA,oBAAYC,cAAZ,CAA4BC,WAA5B,CAAyC,kCACvC,KAAKD,cAAL,CAAsBA,cAAtB,CACA,KAAKC,WAAL,CAAmBA,WAAnB,CACA,KAAKC,SAAL,CAAiB,EAClB,CAED;;;;oEAKQC,Q,CAAU,CAChB,MAAO,MAAKH,cAAL,CAAoBG,QAApB,CACR,CAED;;;;;;;uDAQaC,S,CAAWD,Q,CAAUE,K,CAAOC,Q,CAAU,gBACjD,MAAO,MAAKC,OAAL,CAAaJ,QAAb,EAAuBK,IAAvB,CAA4B,SAACC,GAAD,CAAS,CAC1C,iBAAOC,GAAP,CAAW,MAAKR,SAAhB,CAA2B,CAACE,SAAD,CAAYE,QAAZ,CAA3B,CAAkDH,QAAlD,EACAM,IAAIE,YAAJ,CACEP,SADF,CACaC,KADb,CACoBC,QADpB,CAEE,SAACF,SAAD,CAAYQ,OAAZ,CAAwB,CACtB,MAAKX,WAAL,CAAiBG,SAAjB,CAA4BQ,OAA5B,CACD,CAJH,EAMA,MAAOH,IACR,CATM,CAUR,CAED;;;qEAIoBL,S,CAAW,iBAC7B,GAAIS,SAAU,iBAAOC,GAAP,CAAW,KAAKZ,SAAhB,CAA2B,CAACE,SAAD,CAA3B,CAAd,CAEA,GAAIW,UAAW,EAAf,CACA,IAAK,GAAIT,SAAT,GAAqBO,QAArB,CAA8B,CAC5BE,SAASC,IAAT,CAAe,SAACZ,SAAD,CAAYE,QAAZ,CAAyB,CACtC,MAAO,IAAIW,QAAJ,CAAY,iBAAM,QAAKC,eAAL,CAAqBd,SAArB,CAAgCE,QAAhC,CAAN,CAAZ,CACR,CAFa,CAEXF,SAFW,CAEAE,QAFA,CAAd,CAGD,CAED,MAAOS,SACR,CAED;;;;6DAKgBX,S,CAAWE,Q,CAAU,iBACnC,GAAIH,UAAW,iBAAOW,GAAP,CAAW,KAAKZ,SAAhB,CAA2B,CAACE,SAAD,CAAYE,QAAZ,CAA3B,CAAf,CACA,MAAO,MAAKC,OAAL,CAAaJ,QAAb,EAAuBK,IAAvB,CAA4B,SAACC,GAAD,CAAS,CAC1CA,IAAIS,eAAJ,CACEd,SADF,CACaE,QADb,CAEE,SAACF,SAAD,CAAYQ,OAAZ,CAAwB,CACtB,OAAKX,WAAL,CAAiBG,SAAjB,CAA4BQ,OAA5B,CACD,CAJH,CAMD,CAPM,CAQR,C,yBAGH;;;;;;;GASA;;;;;;;mBASeb,U","file":"ApiManager.js","sourcesContent":["import lodash from 'lodash';\n\n/**\n * Interface for Api instance returnable from custom `adapterFindApi`.\n * @interface Api\n * @memberof module:ancient-cursor\n */\n\n/**\n * @function\n * @memberof module:ancient-cursor\n * @name Api#receiveQuery\n * @param {UniqueId} channelId\n * @param {Query} query\n * @param {UniqueId} cursorId\n * @param {Api~sendBundles} sendBundles\n */\n\n/**\n * @function\n * @memberof module:ancient-cursor\n * @name Api#channelDisconnected\n * @param {UniqueId} channelId\n * @param {Api~sendBundles} sendBundles\n */\n\n/**\n * @function\n * @memberof module:ancient-cursor\n * @name Api#cursorDestroyed\n * @param {UniqueId} channelId\n * @param {UniqueId} cursorId\n * @param {Api~sendBundles} sendBundles\n */\n\n/**\n * @callback ApiManager~sendBundles\n * @memberof module:ancient-cursor\n * @param {UniqueId} channelId\n * @param {Bundle[]} bundles\n */\n\n/**\n * Manager of many api for sync data with cursors.\n * @class\n * @memberof module:ancient-cursor\n */\nclass ApiManager {\n  \n  /**\n   * @constructs ApiManager\n   * @param {ApiManager~adapterFindApi} adapterFindApi\n   * @param {ApiManager~adapterSend} adapterSend\n   */\n  constructor(adapterFindApi, adapterSend) {\n    this.adapterFindApi = adapterFindApi;\n    this.adapterSend = adapterSend;\n    this.relations = {};\n  }\n\n  /**\n   * Find api object.\n   * @param {Query} apiQuery\n   * @returns {Promise} - {@link ApiObject}\n   */\n  findApi(apiQuery) {\n    return this.adapterFindApi(apiQuery);\n  }\n  \n  /**\n   * Receive some query from some channelId, with possible need to sync result with some cursorId on channel cursors namespace.\n   * @param {UniqueId} channelId\n   * @param {Query} apiQuery\n   * @param {Query} query\n   * @param {UniqueId} cursorId\n   * @returns {Promise} - {@link ApiObject}\n   */\n  receiveQuery(channelId, apiQuery, query, cursorId) {\n    return this.findApi(apiQuery).then((api) => {\n      lodash.set(this.relations, [channelId, cursorId], apiQuery);\n      api.receiveQuery(\n        channelId, query, cursorId,\n        (channelId, bundles) => {\n          this.adapterSend(channelId, bundles);\n        }\n      );\n      return api;\n    });\n  }\n  \n  /**\n   * Call channelDisconnected method apply cursorDestroyed for each cursor used in current channelId.\n   * @param {UniqueId} channelId\n   */\n  channelDisconnected(channelId) {\n    var cursors = lodash.get(this.relations, [channelId]);\n    \n    var promises = [];\n    for (var cursorId in cursors) {\n      promises.push(((channelId, cursorId) => {\n        return new Promise(() => this.cursorDestroyed(channelId, cursorId));\n      })(channelId, cursorId));\n    }\n\n    return promises;\n  }\n  \n  /**\n   * Call cursorDestroyed method into api serving for current cursor sync.\n   * @param {UniqueId} channelId\n   * @param {UniqueId} cursorId\n   */\n  cursorDestroyed(channelId, cursorId) {\n    var apiQuery = lodash.get(this.relations, [channelId, cursorId]);\n    return this.findApi(apiQuery).then((api) => {\n      api.cursorDestroyed(\n        channelId, cursorId,\n        (channelId, bundles) => {\n          this.adapterSend(channelId, bundles);\n        }\n      );\n    });\n  }\n}\n\n/**\n * @callback ApiManager~adapterFindApi\n * @memberof module:ancient-cursor\n * @param {Query} apiQuery\n * @returns {Promise} - {@link ApiObject}\n * @description\n * Must be sended into `ApiManager` into constructor. Used for found api instance by apiQuery, from custom application storage logic.\n */\n\n/**\n * @callback ApiManager~adapterSend\n * @memberof module:ancient-cursor\n * @param {UniqueId} channelId\n * @param {Bundle[]} bundles\n * @description\n * Must be sended into `ApiManager` into constructor. Used for send bundles from api to cursor into current and channelId within custom application logic.\n */\n\nexport default ApiManager;"]}