{"version":3,"sources":["../src/tests/index.js"],"names":["require","install","BundlesQueue","id","task","done","describe","it","document","any","custom","many","cursor","equal","get","changesPattern","old","path","action","arguments","on","current","stop","changes","isClone","deepEqual","isTrue","isFalse","set","a","b","c","d","x","e","setTimeout","Error","splice","testString","queue","addBundle","manager","new","cursors","type","value","undefined","start","deleteCount","items","server","clientCursors","bundles","currentPerCursor","query","isEqual","bundlesCounter","client","api","request","clientCursorId","result","cloneDeep","ClientBundlesQueue","bundlesQueue","needData","data","cursor1","cursor2"],"mappings":"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","file":"index.js","sourcesContent":["require('source-map-support').install();\n\nimport { assert } from 'chai';\nimport {\n  Cursor,\n  BundlesQueue as BundlesQueueProto,\n  CursorsManager,\n  executeBundle,\n  executers,\n} from '../lib';\nimport reactTest from './react';\n\nimport lodash from 'lodash';\nimport mingo from 'mingo';\n\nclass BundlesQueue extends BundlesQueueProto {\n  _handler(id, task, done) {\n    task();\n    done();\n  }\n}\n\ndescribe('AncientSouls/Graph', () => {\n  describe('Cursor', () => {\n    it('get by path', () => {\n      var document = { any: [{ custom: { many: 'data' } }] };\n      var cursor = new Cursor(true, document);\n      assert.equal(cursor.get('any.0.custom.many'), 'data');\n    });\n    it('get handle path current set changes', (done) => {\n      var document = { any: [{ custom: { many: 'a' } }] };\n      var cursor = new Cursor(true, document);\n      var changesPattern = {\n        old: { many: 'a' },\n        path: ['any','0','custom'],\n        action: 'set',\n        arguments: ['any.0.custom', { many: 'b' }],\n      };\n      cursor.on('any.0.custom.many', (old, current, stop, changes, isClone) => {\n        assert.equal(old, 'a');\n        assert.equal(current, 'b');\n        assert.deepEqual(changes, changesPattern);\n        assert.isTrue(isClone);\n      });\n      cursor.on('any.0.custom', function(old, current, stop, changes, isClone) {\n        assert.deepEqual(old, { many: 'a' });\n        assert.deepEqual(current, { many: 'b' });\n        assert.deepEqual(changes, changesPattern);\n        assert.isTrue(isClone);\n      });\n      cursor.on('any.0', function(old, current, stop, changes, isClone) {\n        assert.deepEqual(old, { custom: { many: 'b' } });\n        assert.deepEqual(current, { custom: { many: 'b' } });\n        assert.deepEqual(changes, changesPattern);\n        assert.isFalse(isClone);\n        done();\n      });\n      cursor.set('any.0.custom', { many: 'b' });\n    });\n    it('set', () => {\n      var cursor = new Cursor(true, { a: [{ b: 'x' }, { c: 'y' }, { d: 'z' }] });\n      cursor.set('a.0.b', 'z');\n      assert.deepEqual(cursor.get('a.0'), { b: 'z' });\n      cursor.set('', { x: 'y' });\n      assert.deepEqual(cursor.get(), { x: 'y' });\n    });\n    it('splice', (done) => {\n      var cursor = new Cursor(true, { a: [{ b: 'x' }, { c: 'y' }, { d: 'z' }], e: 'f' });\n      cursor.on('a.1', function(old, current, stop, changes, isClone) {\n        assert.deepEqual(old, { c: 'y' });\n        assert.deepEqual(current, { e: 'q' });\n        assert.isTrue(isClone);\n        setTimeout(done, 100);\n      });\n      cursor.on('a.0', function(old, current, stop, changes, isClone) {\n        assert.deepEqual(old, current);\n        assert.isTrue(isClone);\n      });\n      cursor.on('e', function(old, current, stop, changes, isClone) {\n        throw new Error('It should not be');\n      });\n      cursor.splice('a', 1, 1, { e: 'q' });\n      assert.equal(cursor.get('a.1.e'), 'q');\n    });\n  });\n  describe('BundlesQueue', () => {\n    it('only nextId bundle can be handled', () => {\n      var testString = '';\n      var queue = new BundlesQueue();\n      queue.addBundle(2, () => testString += 'c');\n      queue.addBundle(1, () => testString += 'b');\n      queue.addBundle(0, () => testString += 'a');\n      queue.addBundle(3, () => testString += 'd');\n      assert.equal(testString, 'abcd');\n    });\n  });\n  describe('CursorsManager', () => {\n    it('just should works', () => {\n      var manager = new CursorsManager(Cursor);\n      var cursor = manager.new('any','thing');\n      assert.equal(manager.cursors[cursor.id], cursor);\n    });\n  });\n  describe('bundles', () => {\n    it('set', () => {\n      var manager = new CursorsManager(Cursor);\n      var cursor = manager.new('any',{'some':'thing'});\n      executeBundle({\n        cursor: cursor.id, type: 'set',\n        path: 'some',\n        value: 'other',\n      }, cursor, executers);\n      assert.deepEqual(cursor.get('some'), 'other');\n    });\n    it('unset', () => {\n      var manager = new CursorsManager(Cursor);\n      var cursor = manager.new('any',{'some':'thing'});\n      executeBundle({\n        cursor: cursor.id, type: 'unset',\n        path: 'some',\n      }, cursor, executers);\n      assert.deepEqual(cursor.get('some'), undefined);\n    });\n    it('splice', () => {\n      var manager = new CursorsManager(Cursor);\n      var cursor = manager.new('any',{'some':['things','and','others']});\n      executeBundle({\n        cursor: cursor.id, type: 'splice',\n        path: 'some',\n        start: 2, deleteCount: 0, items: ['some'],\n      }, cursor, executers);\n      assert.deepEqual(cursor.get('some'), ['things','and','some','others']);\n    });\n  });\n  describe('concepts', () => {\n    it('fake primitive server-client', () => {\n      var server = (() => {\n        var cursor = new Cursor(undefined, { a: { b: [{ c: 'd' }, { e: 'f' }] } });\n        var clientCursors = {};\n        \n        cursor.on(null, (old, current, stop) => {\n          var bundles = {};\n          for (var c in clientCursors) {\n            let currentPerCursor = lodash.get(current, clientCursors[c].query);\n            if (!lodash.isEqual(clientCursors[c].old, currentPerCursor)) {\n              clientCursors[c].old = currentPerCursor;\n              bundles[c] = {\n                id: clientCursors[c].bundlesCounter, \n                type: 'set', cursor: c,\n                path: '', value: currentPerCursor,\n              };\n              clientCursors[c].bundlesCounter++;\n            }\n          }\n          client.changes(bundles);\n        });\n        \n        var server = {\n          api: {\n            cursor,\n            clientCursors,\n          },\n          request: (clientCursorId, query) => {\n            var result = lodash.cloneDeep(cursor.get(query));\n            if (!clientCursors[clientCursorId]) {\n              clientCursors[clientCursorId] = {\n                bundlesCounter: 0,\n                query: query,\n                old: result,\n              };\n            }\n            return lodash.cloneDeep(result);\n          },\n        };\n        \n        return server;\n      })();\n      \n      var client = (() => {\n        class ClientBundlesQueue extends BundlesQueueProto {\n          constructor(cursor) {\n            super();\n            this.cursor = cursor;\n          }\n          _handler(id, task, done) {\n            executeBundle(task, this.cursor, executers);\n            done();\n          }\n        }\n        \n        var manager = new CursorsManager(class extends Cursor {\n          constructor() {\n            super(...arguments);\n            this.bundlesQueue = new ClientBundlesQueue(this);\n          }\n        });\n        \n        return {\n          api: {\n            manager,\n            needData: (query) => {\n              var cursor = manager.new(query);\n              var data = server.request(cursor.id, query);\n              cursor.set(null, data);\n              return cursor;\n            },\n          },\n          changes: (bundles) => {\n            for (var b in bundles) {\n              if (manager.cursors[bundles[b].cursor]) {\n                manager.cursors[bundles[b].cursor].bundlesQueue.addBundle(bundles[b].id, bundles[b]);\n              }\n            }\n          }\n        };\n      })();\n      \n      var cursor1 = client.api.needData('a');\n      var cursor2 = client.api.needData('a.b[0]');\n      \n      assert.deepEqual(cursor1.get(), server.api.cursor.get('a'));\n      assert.deepEqual(cursor2.get('c'), server.api.cursor.get('a.b[0].c'));\n      \n      server.api.cursor.set('a.b[0].c', 'j');\n      \n      assert.deepEqual(cursor1.get(), server.api.cursor.get('a'));\n      assert.deepEqual(cursor2.get('c'), server.api.cursor.get('a.b[0].c'));\n      \n      server.api.cursor.splice('a.b', 0, 1, 'abrvalk');\n      \n      assert.deepEqual(cursor1.get(), server.api.cursor.get('a'));\n      assert.deepEqual(cursor2.get(), server.api.cursor.get('a.b[0]'));\n    });\n    reactTest();\n  });\n});"]}